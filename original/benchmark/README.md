# Comparison of Transformations for Single-Cell RNA-Seq Data

This folder contains the code for the consistency, simulation, and downsampling benchmarks.

## Run Benchmark

To re-run the code, just call
```{bash}
$> Rscript src/run_benchmarks.R
```

The script will read the `job_overview.yaml` file which details which parameters to use for which benchmark.

The project uses a custom `.Rprofile` generated by [renv](https://rstudio.github.io/renv/articles/renv.html) 
which makes sure that the correct version of each package is used.

Depending on the execution environment, it will be necessary to adapt some folder paths:
* `.OUTPUT_FOLDER` in `src/run_benchmark.R`
* `.SANITY_FOLDER` in `src/transformations/transformation_helper.R`

Furthermore, you need to set up the virtual python environment for _normalisr_ by calling once:
```R
reticulate::virtualenv_install("normalisr_python_env", packages = "normalisr")
```

The benchmark job scheduler is implemented in `src/job_management_utils.R` and is designed around the slurm workload manaager.

## Collect results

After all jobs have finished, you can collect the results by calling 
```{bash}
$> Rscript src/collect_results.R
```
They will be stored in `output/benchmark_results/`.

## Interesting files

* [`src/transformations/transformation_helper.R`](https://github.com/const-ae/transformGamPoi-Paper/blob/master/benchmark/src/transformations/transformation_helper.R) contains a function for each transformation and is thus the best reference to understand how each transformation is called.
* [`src/consistency_benchmark/calculate_10X_consistency.R`](https://github.com/const-ae/transformGamPoi-Paper/blob/master/benchmark/src/consistency_benchmark/calculate_10X_consistency.R), [`src/downsampling_benchmark/calculate_downsampling_agreement.R`](https://github.com/const-ae/transformGamPoi-Paper/blob/master/benchmark/src/downsampling_benchmark/calculate_downsampling_agreement.R), 
and [`src/simulation_benchmark/calculate_ground_truth_overlap.R`](https://github.com/const-ae/transformGamPoi-Paper/blob/master/benchmark/src/simulation_benchmark/calculate_ground_truth_overlap.R) calculate the overlap metrics for the three benchmarks, respectively.
* [`src/simulation_benchmark/simulate_with_XXX.R`](https://github.com/const-ae/transformGamPoi-Paper/tree/master/benchmark/src/simulation_benchmark) contain the code to simulate data with the five simulation frameworks

## Internal workflow management

We wrote a custom workflow management system for this project that is build around the [slurm](https://slurm.schedmd.com/documentation.html), the job submission used at EMBL Heidelberg. The workflow management is implemented in [`src/job_management_utils.R`](https://github.com/const-ae/transformGamPoi-Paper/blob/master/benchmark/src/job_management_utils.R) and automatically stores intermediate results and avoids rerunning scripts if the script and the input arguments have not changed.
